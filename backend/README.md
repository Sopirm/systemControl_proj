# Серверная часть (Backend) «СистемаКонтроля»

Бэкенд системы построен на языке Go с использованием фреймворка Gin.

## Технологический стек

- **Go (Golang)** - основной язык программирования
- **Gin Framework** - веб-фреймворк для создания API
- **GORM** - ORM для работы с базой данных
- **PostgreSQL** - реляционная база данных
- **JWT** - система авторизации на основе токенов
- **Bcrypt** - хеширование паролей

## Структура проекта

```
backend/
├── cmd/             # Дополнительные исполняемые файлы
│   └── migrate/     # Утилита для запуска миграций
├── config/          # Конфигурация приложения
├── controllers/     # Обработчики запросов
│   ├── user_controller.go     # Работа с пользователями
│   ├── project_controller.go  # Работа с проектами
│   ├── defect_controller.go   # Работа с дефектами 
│   ├── comment_controller.go  # Работа с комментариями
│   └── debug_controller.go    # Отладочные функции
├── database/        # Подключение и настройка БД
├── middleware/      # Промежуточные обработчики
│   ├── auth.go      # Авторизация и проверка JWT
├── migrations/      # Миграции базы данных
├── models/          # Модели данных
│   ├── user.go      # Модель пользователя
│   ├── project.go   # Модель проекта
│   ├── defect.go    # Модель дефекта
│   └── comment.go   # Модель комментария
├── routes/          # Настройка маршрутов
├── .env             # Переменные окружения (не в репозитории)
├── .env.example     # Пример файла переменных окружения
├── go.mod           # Зависимости Go
├── go.sum           # Проверочные суммы зависимостей
├── Makefile         # Команды для сборки и запуска
└── main.go          # Точка входа в приложение
```

## Модели данных

В системе определены следующие модели данных:

- **User** - информация о пользователях системы (с ролями: manager, engineer, observer)
- **Project** - информация о проектах/строительных объектах
- **Defect** - информация о дефектах на объектах
- **Comment** - комментарии к дефектам

## Система миграций

Проект использует собственную систему миграций для управления схемой базы данных. Миграции расположены в директории `migrations/` и выполняются в порядке их номеров.

### Структура системы миграций

- **migration.go** - содержит основную логику для применения и отмены миграций
- **runner.go** - список всех миграций и функции для их запуска
- **001_create_users.go, 002_create_projects.go, ...** - отдельные файлы миграций

### Файлы миграций

Каждый файл миграции реализует интерфейс `Migrator` с тремя методами:
1. `Up(tx *gorm.DB) error` - применяет миграцию (создает таблицы, индексы и т.д.)
2. `Down(tx *gorm.DB) error` - отменяет миграцию (удаляет созданные объекты)
3. `Name() string` - возвращает уникальное имя миграции

### Существующие миграции

1. **001_create_users.go** - создание таблицы пользователей
2. **002_create_projects.go** - создание таблицы проектов
3. **003_create_defects.go** - создание таблицы дефектов
4. **004_create_comments.go** - создание таблицы комментариев
5. **005_add_indices.go** - добавление индексов для оптимизации запросов

### Создание новой миграции

Для создания новой миграции:
1. Создайте файл в директории `migrations/` с уникальным номером (например, `006_add_new_feature.go`)
2. Реализуйте интерфейс `Migrator`
3. Добавьте миграцию в список в файле `runner.go`

Пример новой миграции:

```go
package migrations

import (
	"gorm.io/gorm"
)

// AddNewFeature миграция для добавления новой функциональности
type AddNewFeature struct{}

// Up применяет миграцию
func (m *AddNewFeature) Up(tx *gorm.DB) error {
	return tx.Exec(`
		ALTER TABLE users ADD COLUMN phone VARCHAR(20);
	`).Error
}

// Down отменяет миграцию
func (m *AddNewFeature) Down(tx *gorm.DB) error {
	return tx.Exec(`
		ALTER TABLE users DROP COLUMN IF EXISTS phone;
	`).Error
}

// Name возвращает имя миграции
func (m *AddNewFeature) Name() string {
	return "006_add_new_feature"
}
```

## API Endpoints

### Аутентификация

- `POST /auth/register` - регистрация нового пользователя
- `POST /auth/login` - вход в систему (по имени пользователя или email)

### Отладочные маршруты (только для разработки)

- `GET /debug/users` - получение списка всех пользователей
- `POST /debug/reset-password` - сброс пароля пользователя
- `POST /debug/create-test-user` - создание тестового пользователя

### API (требуется авторизация)

- `GET /api/profile` - получение профиля текущего пользователя

#### Управление пользователями (только для менеджеров)

- `GET /api/users` - получение списка всех пользователей
- `PUT /api/users/:id/role` - обновление роли пользователя

#### Проекты

- `GET /api/projects` - список всех проектов
- `GET /api/projects/:id` - информация о проекте
- `POST /api/projects` - создание проекта (только менеджер)
- `PUT /api/projects/:id` - обновление проекта (только менеджер)
- `DELETE /api/projects/:id` - удаление проекта (только менеджер)

#### Дефекты

- `GET /api/defects` - список всех дефектов
- `GET /api/defects/:id` - информация о дефекте
- `POST /api/defects` - создание дефекта
- `PUT /api/defects/:id` - обновление дефекта
- `DELETE /api/defects/:id` - удаление дефекта (только менеджер или инженер)

#### Комментарии

- `GET /api/defects/:defect_id/comments` - получение комментариев к дефекту
- `POST /api/defects/comments` - создание комментария
- `DELETE /api/defects/comments/:id` - удаление комментария (только автор или менеджер)

## Запуск проекта

### Предварительные требования

- Go 1.21 или выше
- PostgreSQL 13 или выше

### Настройка

1. Скопируйте `.env.example` в `.env` и настройте переменные окружения:
   ```bash
   cp .env.example .env
   ```

2. Создайте базу данных в PostgreSQL:
   ```sql
   CREATE DATABASE systemcontrol;
   ```

3. Установите зависимости:
   ```bash
   make deps
   # или
   go mod tidy
   ```

4. Примените миграции:
   ```bash
   make migrate
   # или
   go run cmd/migrate/main.go
   ```

5. Запустите приложение:
   ```bash
   make run
   # или
   go run main.go
   ```

### Управление миграциями

Запуск миграций:
```bash
make migrate
```

Отмена последней миграции:
```bash
make rollback
```

Сборка утилиты миграций:
```bash
go build -o migrate.exe ./cmd/migrate
```

Запуск утилиты миграций:
```bash
./migrate.exe
# или с отменой последней миграции
./migrate.exe --rollback
```

Сервер будет запущен на `http://localhost:8080` (или порт, указанный в `.env`)